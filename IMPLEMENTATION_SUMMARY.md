# PgCs Schema Analyzer - Implementation Summary

## –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å—Ö–µ–º—ã PostgreSQL —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏–∑–≤–ª–µ—á–µ–Ω–∏—è ENUM —Ç–∏–ø–æ–≤. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Å —É—á—ë—Ç–æ–º —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –æ–±—ä–µ–∫—Ç–æ–≤ (Tables, Views, Domains, Composites –∏ —Ç.–¥.).

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. –û–±—â–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ (PgCs.Core/Parsing)

#### `SqlBlock.cs`
–ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –±–ª–æ–∫ SQL –∫–æ–¥–∞ - –æ–¥–Ω—É –∫–æ–º–∞–Ω–¥—É PostgreSQL —Å –ø–æ–ª–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º:
- `Content` - –æ—Å–Ω–æ–≤–Ω–æ–π SQL —Ç–µ–∫—Å—Ç –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
- `RawContent` - –ø–æ–ª–Ω—ã–π –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –≤–∫–ª—é—á–∞—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
- `PrecedingComment` - –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–µ—Ä–µ–¥ –±–ª–æ–∫–æ–º
- `InlineComments` - inline –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞
- `StartLine`, `EndLine` - –ø–æ–∑–∏—Ü–∏—è –≤ —Ñ–∞–π–ª–µ
- `FilePath` - –ø—É—Ç—å –∫ –∏—Å—Ç–æ—á–Ω–∏–∫—É

#### `ISqlBlockParser.cs` / `SqlBlockParser.cs`
–ü–∞—Ä—Å–µ—Ä SQL —Å–∫—Ä–∏–ø—Ç–∞ –Ω–∞ –±–ª–æ–∫–∏ –∫–æ–º–∞–Ω–¥ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π:
- –†–∞–∑–¥–µ–ª–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥ –ø–æ –ø—É—Å—Ç—ã–º —Å—Ç—Ä–æ–∫–∞–º –∏–ª–∏ —Ç–æ—á–∫–µ —Å –∑–∞–ø—è—Ç–æ–π (`;`)
- –ò–∑–≤–ª–µ—á–µ–Ω–∏—è preceding –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (—Ç–æ–ª—å–∫–æ –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –ø–µ—Ä–µ–¥ –±–ª–æ–∫–æ–º)
- –û–±—Ä–∞–±–æ—Ç–∫–∏ inline –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (`--`)
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏
- –£–º–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞ accumulated –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø—Ä–∏ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫–∞—Ö

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ë–ª–æ–∫ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π –ò–õ–ò —Ç–æ—á–∫–æ–π —Å –∑–∞–ø—è—Ç–æ–π
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ—Ç–¥–µ–ª—ë–Ω–Ω—ã–µ –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π –æ—Ç –∫–æ–º–∞–Ω–¥—ã –Ω–µ –≤–∫–ª—é—á–∞—é—Ç—Å—è
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π C# 14 (source generators)

### 2. –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞ (PgCs.Core/Schema/Analyzer)

#### `ParsingContext.cs`
–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ —Å–æ—Å–µ–¥–Ω–∏–º –±–ª–æ–∫–∞–º:
- `CurrentBlock` - —Ç–µ–∫—É—â–∏–π –±–ª–æ–∫
- `NextBlock` - —Å–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫ (–¥–ª—è –ø–æ–∏—Å–∫–∞ COMMENT ON)
- `PreviousBlock` - –ø—Ä–µ–¥—ã–¥—É—â–∏–π –±–ª–æ–∫
- `GetNextBlocks(count)` - –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ª–µ–¥—É—é—â–∏—Ö –±–ª–æ–∫–æ–≤

–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–∞—Ä—Å–µ—Ä–∞–º —Å–º–æ—Ç—Ä–µ—Ç—å –≤–ø–µ—Ä—ë–¥ –¥–ª—è —Å–≤—è–∑—ã–≤–∞–Ω–∏—è, –Ω–∞–ø—Ä–∏–º–µ—Ä, `CREATE TYPE` —Å `COMMENT ON TYPE`.

### 3. –ü–∞—Ä—Å–µ—Ä ENUM —Ç–∏–ø–æ–≤

#### `IEnumTypeParser.cs` (PgCs.Core)
–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è ENUM —Ç–∏–ø–æ–≤ —Å –º–µ—Ç–æ–¥–æ–º:
```csharp
bool TryParse(ParsingContext context, 
              out EnumTypeDefinition? enumDefinition, 
              out IReadOnlyList<ValidationIssue> validationIssues);
```

#### `EnumTypeParser.cs` (PgCs.SchemaAnalyzer.Tante/Parsers)
–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ä—Å–µ—Ä–∞ ENUM —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π:
- –†–µ–≥—É–ª—è—Ä–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è `CREATE TYPE ... AS ENUM`
- –ò–∑–≤–ª–µ—á–µ–Ω–∏—è —Å—Ö–µ–º—ã –∏ –∏–º–µ–Ω–∏ —Ç–∏–ø–∞
- –ü–∞—Ä—Å–∏–Ω–≥–∞ –∑–Ω–∞—á–µ–Ω–∏–π ENUM (—Å –∫–∞–≤—ã—á–∫–∞–º–∏ –∏–ª–∏ –±–µ–∑)
- –ü–æ–∏—Å–∫–∞ `COMMENT ON TYPE` –≤ —Å–ª–µ–¥—É—é—â–µ–º –±–ª–æ–∫–µ
- Fallback –Ω–∞ preceding comment –µ—Å–ª–∏ COMMENT ON TYPE –Ω–µ –Ω–∞–π–¥–µ–Ω
- –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ ValidationIssue –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:**
```sql
-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–µ—Ä–µ–¥
CREATE TYPE status AS ENUM ('active', 'inactive');

-- –∏–ª–∏

CREATE TYPE status AS ENUM ('active', 'inactive');
COMMENT ON TYPE status IS '–°—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';

-- –∏–ª–∏ —Å —Å—Ö–µ–º–æ–π

CREATE TYPE public.status AS ENUM ('active', 'inactive');
COMMENT ON TYPE public.status IS '–°—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
```

### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ValidationIssue

–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –æ–±—ä–µ–∫—Ç–æ–≤ –≤ `ValidationDefinitionType`:
- `Enum` - ENUM —Ç–∏–ø
- `Composite` - Composite —Ç–∏–ø
- `Domain` - Domain —Ç–∏–ø
- `Query` - SQL –∑–∞–ø—Ä–æ—Å

### 5. SchemaAnalyzer (PgCs.SchemaAnalyzer.Tante)

#### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã:

**`AnalyzeFileAsync`**
- –ß–∏—Ç–∞–µ—Ç SQL —Ñ–∞–π–ª –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
- –ü–∞—Ä—Å–∏—Ç –Ω–∞ –±–ª–æ–∫–∏ —á–µ—Ä–µ–∑ `SqlBlockParser`
- –ò–∑–≤–ª–µ–∫–∞–µ—Ç ENUM —Ç–∏–ø—ã —á–µ—Ä–µ–∑ `EnumTypeParser`
- –°–æ–±–∏—Ä–∞–µ—Ç ValidationIssues
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `SchemaMetadata`

**`AnalyzeDirectoryAsync`**
- –°–∫–∞–Ω–∏—Ä—É–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ (`*.sql`)
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª
- –û–±—ä–µ–¥–∏–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—â—É—é `SchemaMetadata`

**`ExtractEnums`**
- –ü—É–±–ª–∏—á–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è ENUM –∏–∑ SQL —Å–∫—Ä–∏–ø—Ç–∞
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π `ExtractEnumsInternal` —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π filePath

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

1. **–û–¥–∏–Ω —Ñ–∞–π–ª - –æ–¥–∏–Ω –∫–ª–∞—Å—Å** - –∫–∞–∂–¥—ã–π –∫–ª–∞—Å—Å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ
2. **–ú–∏–Ω–∏–º—É–º –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤** - –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
3. **–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç–∏** - `ISqlBlockParser`, `IEnumTypeParser`
4. **Immutable –º–æ–¥–µ–ª–∏** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `record` –∏ `required` —Å–≤–æ–π—Å—Ç–≤
5. **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –∫–æ–¥** - source generated —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è, `Span<T>` –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ
6. **–ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø–∞—Ä—Å–µ—Ä–æ–≤** - `ParsingContext` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —Å–æ—Å–µ–¥–Ω–∏–º –±–ª–æ–∫–∞–º

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```csharp
using PgCs.SchemaAnalyzer.Tante;

var analyzer = new SchemaAnalyzer();

// –ê–Ω–∞–ª–∏–∑ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
var metadata = await analyzer.AnalyzeFileAsync("schema.sql");

// –ê–Ω–∞–ª–∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
var metadata = await analyzer.AnalyzeDirectoryAsync("./schemas");

// –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ ENUM
var enums = analyzer.ExtractEnums(sqlScript);

// –†–∞–±–æ—Ç–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
foreach (var enumType in metadata.Enums)
{
    Console.WriteLine($"ENUM: {enumType.Name}");
    Console.WriteLine($"Values: {string.Join(", ", enumType.Values)}");
    Console.WriteLine($"Comment: {enumType.Comment}");
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ ValidationIssues
foreach (var issue in metadata.ValidationIssues)
{
    Console.WriteLine($"[{issue.Severity}] {issue.Code}: {issue.Message}");
}
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ó–∞–ø—É—Å–∫ CLI –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
```bash
dotnet run --project src/PgCs.Cli/PgCs.Cli.csproj src/PgCs.Core/Example/Schema.sql
```

–†–µ–∑—É–ª—å—Ç–∞—Ç:
```
üì¶ ENUM: user_status
   Values: [active, inactive, suspended, deleted]
   Comment: –í–æ–∑–º–æ–∂–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–∏—Å—Ç–µ–º–µ

üì¶ ENUM: order_status
   Values: [pending, processing, shipped, delivered, cancelled]
   Comment: –°—Ç–∞—Ç—É—Å—ã –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –∑–∞–∫–∞–∑–∞

...
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –æ–±—ä–µ–∫—Ç–æ–≤:

1. –°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–∞—Ä—Å–µ—Ä–∞ –≤ `PgCs.Core/Schema/Analyzer` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `ITableParser`)
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–∞—Ä—Å–µ—Ä –≤ `PgCs.SchemaAnalyzer.Tante/Parsers`
3. –î–æ–±–∞–≤–∏—Ç—å —Ç–∏–ø –≤ `ValidationDefinitionType` –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
4. –û–±–Ω–æ–≤–∏—Ç—å `SchemaAnalyzer` –¥–æ–±–∞–≤–∏–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ Extract
5. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ `AnalyzeFileAsync` –∏ `AnalyzeDirectoryAsync`

**–û–±—â–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞ –∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–∞:**
- `SqlBlockParser` - –ø–∞—Ä—Å–∏–Ω–≥ –ª—é–±—ã—Ö SQL –∫–æ–º–∞–Ω–¥
- `ParsingContext` - –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ª—é–±—ã—Ö –ø–∞—Ä—Å–µ—Ä–æ–≤
- `ValidationIssue` - –µ–¥–∏–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- `SchemaMetadata` - –æ–±—â–∞—è –º–æ–¥–µ–ª—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

- C# 14 features
- .NET 9
- PostgreSQL 18 syntax
- Async/await patterns
- Source generators –¥–ª—è regex
