```
РЕОРГАНИЗАЦИЯ ТЕСТОВ - ВИЗУАЛЬНАЯ СХЕМА
========================================

┌─────────────────────────────────────────────────────────────────┐
│  ДО: Data/SepatatedFiles/ (16 файлов - ДУБЛИРОВАНИЕ)           │
├─────────────────────────────────────────────────────────────────┤
│  ├── CreateEnum.sql                                              │
│  ├── CreateCompositeType.sql                                     │
│  ├── CreateDomain.sql                                            │
│  ├── CreateTable.sql                  ┌──────────────────────┐  │
│  ├── CreateView.sql                   │  Дублируют           │  │
│  ├── CreateFunction.sql               │  Unit-тесты!         │  │
│  ├── CreateIndex.sql                  │  ❌ Избыточность     │  │
│  ├── CreateTrigger.sql                └──────────────────────┘  │
│  ├── AddCommentToEnum.sql                                        │
│  ├── AddCommentToCompositeType.sql                               │
│  ├── AddCommentToDomain.sql                                      │
│  ├── AddCommentToTable.sql                                       │
│  ├── AddCommentToView.sql                                        │
│  ├── AddCommentToFunction.sql                                    │
│  ├── AddCommentToIndex.sql                                       │
│  └── AddCommentToTrigger.sql                                     │
└─────────────────────────────────────────────────────────────────┘

                            ⬇️  РЕОРГАНИЗАЦИЯ

┌─────────────────────────────────────────────────────────────────┐
│  ПОСЛЕ: Чистая архитектура (9 файлов - БЕЗ ДУБЛИРОВАНИЯ)       │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  📂 Data/FullSchema/                                             │
│     └── Schema.sql          ← Полная схема для основного теста   │
│                                                                   │
│  📂 Data/MultiFile/         ← Тест "множество файлов"           │
│     ├── 01_types_and_domains.sql    (ENUMs, Composites, Domains)│
│     ├── 02_tables.sql               (4 таблицы + FK)            │
│     ├── 03_indexes.sql              (15+ индексов)              │
│     └── 04_functions_and_triggers.sql (3 функции + 4 триггера)  │
│                                                                   │
│  📂 Data/EdgeCases/         ← Граничные случаи                  │
│     ├── EmptyFile.sql               (пустой файл)               │
│     ├── OnlyComments.sql            (только комментарии)        │
│     ├── InvalidSyntax.sql           (синтаксические ошибки)     │
│     └── SpecialCharacters.sql       (emoji, unicode, кириллица) │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘


УРОВНИ ТЕСТИРОВАНИЯ
===================

┌──────────────────────────────────────────────────────────────────┐
│  UNIT-ТЕСТЫ (детальная проверка синтаксиса)                      │
├──────────────────────────────────────────────────────────────────┤
│  ✅ TableExtractorTests      - CREATE TABLE со всеми вариантами  │
│  ✅ FunctionExtractorTests   - CREATE FUNCTION с параметрами     │
│  ✅ EnumExtractorTests        - CREATE TYPE AS ENUM              │
│  ✅ CompositeExtractorTests   - CREATE TYPE (composite)          │
│  ✅ DomainExtractorTests      - CREATE DOMAIN                    │
│  ✅ ViewExtractorTests        - CREATE VIEW / MATERIALIZED VIEW  │
│  ✅ IndexExtractorTests       - CREATE INDEX всех типов          │
│  ✅ TriggerExtractorTests     - CREATE TRIGGER                   │
│  ✅ ConstraintExtractorTests  - ALTER TABLE ADD CONSTRAINT       │
│  ✅ PartitionExtractorTests   - CREATE TABLE PARTITION           │
│  ✅ CommentExtractorTests     - COMMENT ON различных объектов    │
└──────────────────────────────────────────────────────────────────┘

                                 ⬇️

┌──────────────────────────────────────────────────────────────────┐
│  INTEGRATION-ТЕСТЫ (реальные сценарии использования)             │
├──────────────────────────────────────────────────────────────────┤
│                                                                    │
│  1️⃣  AnalyzeFullSchema_ExtractsAllObjectsCorrectly()            │
│      └─ Проверка: вся схема в одном файле (~1000 строк)          │
│         ✅ 4 ENUMs, 2 Composites, 4 Domains                      │
│         ✅ 5 Tables, 4 Partitions                                │
│         ✅ 2 Views (обычное + материализованное)                 │
│         ✅ 6 Functions, 6 Triggers                               │
│         ✅ 30 Indexes, 158 Comments                              │
│                                                                    │
│  2️⃣  AnalyzeMultipleFiles_ExtractsAllObjectsCorrectly()         │
│      └─ Проверка: схема разбита на 4 файла                       │
│         ✅ Правильная агрегация результатов                      │
│         ✅ 4 source paths в метаданных                           │
│         ✅ FK между таблицами корректны                          │
│                                                                    │
│  3️⃣  AnalyzeEdgeCases_HandlesGracefully()                       │
│      └─ Проверка: граничные случаи                               │
│         ✅ Пустые файлы → не падает, возвращает пустые данные    │
│         ✅ Только комментарии → корректная обработка             │
│         ✅ Синтаксические ошибки → ValidationIssues              │
│         ✅ Спецсимволы → корректное извлечение                   │
│                                                                    │
│  4️⃣  AnalyzeFullSchema_CompletesInReasonableTime()              │
│      └─ Проверка: производительность < 5 секунд                  │
│                                                                    │
│  5️⃣  AnalyzeFullSchema_MaintainsObjectRelationships()           │
│      └─ Проверка: целостность связей (FK, Partitions, Comments)  │
│                                                                    │
└──────────────────────────────────────────────────────────────────┘


ИСПРАВЛЕНИЯ В КОДЕ
==================

SchemaAnalyzer.cs - обработка пустых файлов:

  ❌ БЫЛО:
     var blocks = BlockParser.Parse(sqlContent);
     ↓ ArgumentException если файл пустой!
  
  ✅ СТАЛО:
     if (string.IsNullOrWhiteSpace(sqlContent)) {
         return CreateEmptyMetadata([schemaFilePath], schemaFilePath);
     }
     var blocks = BlockParser.Parse(sqlContent);
     ↓ Корректная обработка пустых файлов


PgCs.SchemaAnalyzer.Tante.Tests.csproj - упрощение:

  ❌ БЫЛО (80+ строк):
     <None Update="Data\SepatatedFiles\CreateTable.sql">
       <CopyToOutputDirectory>Always</CopyToOutputDirectory>
     </None>
     <None Update="Data\SepatatedFiles\CreateEnum.sql">
       <CopyToOutputDirectory>Always</CopyToOutputDirectory>
     </None>
     ... (ещё 50+ строк) ...
  
  ✅ СТАЛО (20 строк):
     <None Update="Data\MultiFile\*.sql">
       <CopyToOutputDirectory>Always</CopyToOutputDirectory>
     </None>
     <None Update="Data\EdgeCases\*.sql">
       <CopyToOutputDirectory>Always</CopyToOutputDirectory>
     </None>


МЕТРИКИ УЛУЧШЕНИЯ
=================

  📉 Тестовых файлов:     17 → 9  (-47%)
  📈 Интеграционных:       4 → 5  (+25%)
  📉 Строк в .csproj:     80 → 20 (-75%)
  ✅ Дублирование:        Да → Нет
  ✅ Граничные случаи:    Нет → Есть
  ✅ Пустые файлы:        Ошибка → OK


ИТОГ
====

✅ Архитектура тестов улучшена
✅ Дублирование устранено
✅ Покрытие расширено (граничные случаи)
✅ Код надёжнее (обработка пустых файлов)
✅ Поддержка проще (wildcards в .csproj)

Готово к использованию! 🎉
```

